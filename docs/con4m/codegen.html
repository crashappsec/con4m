<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>src/con4m/codegen</title>
<link rel="stylesheet" type="text/css" href="../nimdoc.out.css">

<script type="text/javascript" src="../dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  if (toggleSwitch !== null) {
    toggleSwitch.addEventListener('change', switchTheme, false);
  }

  var currentTheme = localStorage.getItem('theme');
  if (!currentTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    currentTheme = 'dark';
  }
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark' && toggleSwitch !== null) {
      toggleSwitch.checked = true;
    }
  }
}

window.addEventListener('DOMContentLoaded', main);
</script>

</head>
<body>
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">src/con4m/codegen</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="../theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<ul class="simple"><li><a class="reference" id="the-nimsection-command_toc" href="#the-nimsection-command">The <tt class="docutils literal"><span class="pre"><span class="Identifier">section</span></span></tt> command</a></li>
<li><a class="reference" id="the-nimattr-command_toc" href="#the-nimattr-command">The <tt class="docutils literal"><span class="pre"><span class="Identifier">attr</span></span></tt> command</a></li>
</ul><li>
  <a class="reference reference-toplevel" href="#6" id="56">Imports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#18" id="68">Templates</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">con4m
      <li><a class="reference" href="#con4m.t%2Cuntyped%2Cstring%2Cuntyped"
    title="con4m(nameBase: untyped; confstr: string; rest: untyped): untyped">con4m(nameBase: untyped; confstr: string; rest: untyped): untyped</a></li>

  </ul>
  <ul class="simple nested-toc-section">configDef
      <li><a class="reference" href="#configDef.t%2Cuntyped%2Cuntyped"
    title="configDef(nameNode: untyped; rest: untyped)">configDef(nameNode: untyped; rest: untyped)</a></li>

  </ul>

  </ul>
</li>

</ul>

  </div>
  &nbsp;&nbsp;<a
href="https://github.com/crashappsec/con4m.git/tree/v0.2.3/src/con4m/codegen.nim#L1"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/crashappsec/con4m.git/edit/devel/src/con4m/codegen.nim#L1" class="link-seesrc" target="_blank" >Edit</a>

  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc">Macros for abstracting away config file specification, parsing, validation and loading.<table class="docinfo" frame="void" rules="none"><col class="docinfo-name" /><col class="docinfo-content" /><tbody valign="top"><tr><th class="docinfo-name">Author:</th><td>John Viega (john@crashoverride.com)</td></tr>
<tr><th class="docinfo-name">Copyright:</th><td>2022</td></tr>
</tbody></table>More helper functions for creating symbol names that we'll use.</p>
  <div class="section" id="6">
<h1><a class="toc-backref" href="#6">Imports</a></h1>
<dl class="item">
<a class="reference external" href="types.html">types</a>, <a class="reference external" href="st.html">st</a>, <a class="reference external" href="spec.html">spec</a>, <a class="reference external" href="eval.html">eval</a>, <a class="reference external" href="parse.html">parse</a>
</dl></div>
<div class="section" id="18">
<h1><a class="toc-backref" href="#18">Templates</a></h1>
<dl class="item">
<div id="con4m.t,untyped,string,untyped">
<dt><pre><span class="Keyword">template</span> <a href="#con4m.t%2Cuntyped%2Cstring%2Cuntyped"><span class="Identifier">con4m</span></a><span class="Other">(</span><span class="Identifier">nameBase</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">;</span> <span class="Identifier">confstr</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">;</span> <span class="Identifier">rest</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">untyped</span></pre></dt>
<dd>

This is our main wrapper that bundles up parsing, checking, evaling, ... It both returns your config object, but also injects the context object so you can load a second file on top of it.<dl class="docutils"><dt><tt class="docutils literal"><span class="pre"><span class="Identifier">nameBase</span></span></tt> is the base name of your configuration file. Con4m</dt>
<dd>will use that to generate some of the symbols it exports.</dd>
</dl>
<p>Currently, this macro will export a few different symbols, specifically:</p>
<ol class="simple"><li>If the first parameter is <tt class="docutils literal"><span class="pre"><span class="Identifier">example</span></span></tt> It will inject a symbol called <tt class="docutils literal"><span class="pre"><span class="Identifier">ctxExampleConf</span></span></tt>, which will be an object representing your configuration, from which you can access the fields directly once the configuration file is loaded, using the names in the specification you provide in this macro (see below).</li>
<li>A type declaration for the previous symbol.  Again, if the first parameter is <tt class="docutils literal"><span class="pre"><span class="Identifier">example</span></span></tt>, then the top level type will be called <tt class="docutils literal"><span class="pre"><span class="Identifier">ExampleConfig</span></span></tt>.  So your context will have been declared: <tt class="docutils literal"><span class="pre"><span class="Identifier">ctxExampleConf</span><span class="Punctuation">:</span> <span class="Identifier">ExampleConfig</span></span></tt>.</li>
<li>Type declarations for each unique section you defined. Currently, if a section name is, for example <tt class="docutils literal"><span class="pre"><span class="Identifier">host</span></span></tt>, it will take the form of: <tt class="docutils literal"><span class="pre"><span class="Identifier">HostSection</span></span></tt>.</li>
<li>There are some helper variables that need to be hidden, because they don't need to be exposed, but I haven't done that yet: <tt class="docutils literal"><span class="pre"><span class="Identifier">tmpBox</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">currentSt</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">sections</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">stEntry</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">entryOpt</span></span></tt>, <tt class="docutils literal"><span class="pre"><span class="Identifier">confSpecExample</span></span></tt> (where Example is your name).  Again, all of these should go away.</li>
<li>A function called <tt class="docutils literal"><span class="pre"><span class="Identifier">loadExampleConf</span><span class="Punctuation">(</span><span class="Identifier">ctx</span><span class="Punctuation">:</span> <span class="Identifier">ExampleConfig</span><span class="Punctuation">)</span></span></tt>. <tt class="docutils literal"><span class="pre"><span class="Identifier">con4m</span><span class="Punctuation">(</span><span class="Punctuation">)</span></span></tt> actually calls this function for you, but you can re-call it if you need to.  There is a lower-level version of the macro that this builds upon, called <tt class="docutils literal"><span class="pre"><span class="Identifier">configDef</span></span></tt>, that does NOT call it for you, if you need to customize more.</li>
</ol>
<p>The <tt class="docutils literal"><span class="pre"><span class="Identifier">confstr</span></span></tt> argument is the configuration file you want to parse.</p>
<blockquote><p>While <tt class="docutils literal"><span class="pre"><span class="Identifier">con4m</span><span class="Punctuation">(</span><span class="Punctuation">)</span></span></tt> does NOT read in the config file for you, it</p></blockquote>
<p>does do everything else... parse it, check it for consistency, evaluate it, check it against your specification.  The <tt class="docutils literal"><span class="pre"><span class="Identifier">configDef</span><span class="Punctuation">(</span><span class="Punctuation">)</span></span></tt> just generates the supporting code to build the spec.</p>
<p>Because we generate a proc for you, <tt class="docutils literal"><span class="pre"><span class="Identifier">con4m</span><span class="Punctuation">(</span><span class="Punctuation">)</span></span></tt> cannot be invoked from within a function, only at the module level (a nested procedure wouldn't be intuitive).</p>
<p>The last argument to <tt class="docutils literal"><span class="pre"><span class="Identifier">con4m</span><span class="Punctuation">(</span><span class="Punctuation">)</span></span></tt> is a block of commands to define sections and attributes.  No other code may appear in this block; it will result in an error.</p>
<p>Currently, there are only two commands:</p>
<p><tt class="docutils literal"><span class="pre"><span class="Identifier">section</span></span></tt>, which creates a section definition; and</p>
<dl class="docutils"><dt><tt class="docutils literal"><span class="pre"><span class="Identifier">attr</span></span></tt>, which defines an attribute, placing it either in the</dt>
<dd>section (When the attribute appears in a section block), or as an attribute in the global namespace, when not.</dd>
</dl>

<h2><a class="toc-backref" id="the-nimsection-command" href="#the-nimsection-command">The <tt class="docutils literal"><span class="pre"><span class="Identifier">section</span></span></tt> command</a></h2><p>This takes only two required arguments:</p>
<ul class="simple"><li>The first argument is always the name of a section, as an identifier.  Eg, <tt class="docutils literal"><span class="pre"><span class="Identifier">host</span></span></tt></li>
<li>The last argument is a block, which can constitute <tt class="docutils literal"><span class="pre"><span class="Identifier">attr</span></span></tt> commands, or other section commands. Eventually, nested subsections will define sections that only apply inside the specified section.  However, they currently just create a new top-level section.</li>
</ul>
<p>Optional keyword commands to <tt class="docutils literal"><span class="pre"><span class="Identifier">section</span></span></tt></p>
<ol class="simple"><li><tt class="docutils literal"><span class="pre"><span class="Identifier">allowCustomAttrs</span></span></tt>, a boolean, indicating whether the user should be allowed to make up their own attributes in this section. This defaults to <tt class="docutils literal"><span class="pre"><span class="Identifier">false</span></span></tt>.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">doc</span></span></tt>, a string, which is documentation for that part of the configuration file. While this is stored if provided, it currently is unused.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">requiredSubSections</span></span></tt>, a <tt class="docutils literal"><span class="pre"><span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span></span></tt> of subsection names that a user MUST provide. Provide each option in dot notation, and a name can be replaced with a <tt class="docutils literal"><span class="pre"><span class="StringLit">&quot;*&quot;</span></span></tt> to match anything for that dot.  If not provided, there are no required sections.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">allowedSubSections</span></span></tt>, also a <tt class="docutils literal"><span class="pre"><span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span></span></tt>, which is very similar, and again, is not checked if not provided.  Note that <tt class="docutils literal"><span class="pre"><span class="Identifier">requiredSubsections</span></span></tt> are implicitly allowed, so you don't need to double spec them.  If not provided, this defaults to &quot;*&quot;, allowing any section name, but no nesting.  Not providing either would disallow any subsection, only allowing a single instance of the toplevel section.</li>
</ol>
<p>Subsections are probably misnomers here, where we will probably change the terminology at some point.  This are more section modifiers, the set of which needs to be unique.  Subsections will become nested sections of different types, once we implement those.</p>
<p>Currently, the macros do NOT provide an interface to any user-defined attributes.  You have to search through the raw data manually. Making such items available more directly is a TODO item.</p>

<h2><a class="toc-backref" id="the-nimattr-command" href="#the-nimattr-command">The <tt class="docutils literal"><span class="pre"><span class="Identifier">attr</span></span></tt> command</a></h2><p>This command takes the following arguments:</p>
<ol class="simple"><li>The name of the attribute, as an identifier.  Note that it's okay to use Nim keywords here, they get automatically quoted (this also happens when they are used in sections).  This is required.</li>
<li>The Con4m type to enforce for the attribute (NOT the Nim type). This is required.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">defaultVal</span></span></tt>, a keyword parameter specifying what value to set if the user does not provide something for this attribute, when defining a section.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">required</span></span></tt>, a keyword parameter indicating whether con4m should throw an error when this is not present in a section. If you set <tt class="docutils literal"><span class="pre"><span class="Identifier">defaultVal</span></span></tt>, this will be ignored.  This defaults to <tt class="docutils literal"><span class="pre"><span class="Identifier">true</span></span></tt> if not provided.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">lockOnWrite</span></span></tt>, a keyword parameter indicating that, once a configuration has set this value, it may not be written in future config file loads that reuse the same underlying configuration state.  This allows you to provide internal &quot;configuration&quot; parameters within your program (by reading your config from a string in memory, for instance), without risking them getting clobbered.  This defaults to false.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">doc</span></span></tt>, a keyword parameter, represents a doc string. But, as above, this is not yet used.</li>
<li><tt class="docutils literal"><span class="pre"><span class="Identifier">validator</span></span></tt>, a custom callback for this field so that you can easily do additional validation beyond what con4m already does. This is NOT yet implemented.</li>
</ol>
<p>Note that fields that are <em>not</em> required and do not have a default provided will be declared as <tt class="docutils literal"><span class="pre"><span class="Identifier">Optional</span><span class="Punctuation">[</span><span class="Punctuation">]</span></span></tt> types so you can determine whether the user provided them safely.</p>
<p>In future releases, we expect to handle nested sections, and also to make it easy to configure adding custom builtin functions with a separate command.</p>
<p>Note that Nim allows you to use <tt class="docutils literal"><span class="pre"><span class="Identifier">attribute_name</span></span></tt> and <tt class="docutils literal"><span class="pre"><span class="Identifier">attributeName</span></span></tt> interchangably.  However, con4m does NOT, it will only accept the name you provide. </p>

&nbsp;&nbsp;<a
href="https://github.com/crashappsec/con4m.git/tree/v0.2.3/src/con4m/codegen.nim#L1215"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/crashappsec/con4m.git/edit/devel/src/con4m/codegen.nim#L1215" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>
<div id="configDef.t,untyped,untyped">
<dt><pre><span class="Keyword">template</span> <a href="#configDef.t%2Cuntyped%2Cuntyped"><span class="Identifier">configDef</span></a><span class="Other">(</span><span class="Identifier">nameNode</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">;</span> <span class="Identifier">rest</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span></pre></dt>
<dd>

<p>This template calls our macro does all the definitions for us, but does not handle the parsing, evaluation, or checking.  It just generates code for us. The kludge variable is to ensure we don't run in a function scope, so that we can inject the loadNNNConfig() procedure.</p>
<p>This is particularly useful when we want to add our own custom built-in functions.  We may change those to be part of the macro system.</p>

&nbsp;&nbsp;<a
href="https://github.com/crashappsec/con4m.git/tree/v0.2.3/src/con4m/codegen.nim#L1202"
class="link-seesrc" target="_blank">Source</a>
&nbsp;&nbsp;<a href="https://github.com/crashappsec/con4m.git/edit/devel/src/con4m/codegen.nim#L1202" class="link-seesrc" target="_blank" >Edit</a>

</dd>
</div>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2022-12-19 06:48:56 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
